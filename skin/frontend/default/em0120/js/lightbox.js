var Lightbox=Class.create();Lightbox.prototype={imageArray:[],activeImage:undefined,initialize:function(){this.updateImageList();this.keyboardAction=this.keyboardAction.bindAsEventListener(this);if(LightboxOptions.resizeSpeed>10)LightboxOptions.resizeSpeed=10;if(LightboxOptions.resizeSpeed<1)LightboxOptions.resizeSpeed=1;this.resizeDuration=LightboxOptions.animate?(11-LightboxOptions.resizeSpeed)*.15:0;this.overlayDuration=LightboxOptions.animate?.2:0;var e=(LightboxOptions.animate?250:1)+"px";var t=$$("body")[0];t.appendChild(Builder.node("div",{id:"overlay"}));t.appendChild(Builder.node("div",{id:"lightbox"},[Builder.node("div",{id:"outerImageContainer"},Builder.node("div",{id:"imageContainer"},[Builder.node("img",{id:"lightboxImage"}),Builder.node("div",{id:"hoverNav"},[Builder.node("a",{id:"prevLink",href:"#"}),Builder.node("a",{id:"nextLink",href:"#"})]),Builder.node("div",{id:"loading"},Builder.node("a",{id:"loadingLink",href:"#"},Builder.node("img",{src:LightboxOptions.fileLoadingImage})))])),Builder.node("div",{id:"imageDataContainer"},Builder.node("div",{id:"imageData"},[Builder.node("div",{id:"imageDetails"},[Builder.node("span",{id:"caption"}),Builder.node("span",{id:"numberDisplay"})]),Builder.node("div",{id:"bottomNav"},Builder.node("a",{id:"bottomNavClose",href:"#"},Builder.node("img",{src:LightboxOptions.fileBottomNavCloseImage})))]))]));$("overlay").hide().observe("click",function(){this.end()}.bind(this));$("lightbox").hide().observe("click",function(e){if(e.element().id=="lightbox")this.end()}.bind(this));$("outerImageContainer").setStyle({width:e,height:e});$("prevLink").observe("click",function(e){e.stop();this.changeImage(this.activeImage-1)}.bindAsEventListener(this));$("nextLink").observe("click",function(e){e.stop();this.changeImage(this.activeImage+1)}.bindAsEventListener(this));$("loadingLink").observe("click",function(e){e.stop();this.end()}.bind(this));$("bottomNavClose").observe("click",function(e){e.stop();this.end()}.bind(this));var n=this;(function(){var e="overlay lightbox outerImageContainer imageContainer lightboxImage hoverNav prevLink nextLink loading loadingLink "+"imageDataContainer imageData imageDetails caption numberDisplay bottomNav bottomNavClose";$w(e).each(function(e){n[e]=$(e)})}).defer()},updateImageList:function(){this.updateImageList=Prototype.emptyFunction;document.observe("click",function(e){var t=e.findElement("a[rel^=lightbox]")||e.findElement("area[rel^=lightbox]");if(t&&t.rel&&t.rel.indexOf("lightbox")>=0){if(window.document.documentMode>=9)Event.stop(window.event);else e.stop();this.start(t)}}.bind(this))},start:function(e){$$("select","object","embed").each(function(e){e.style.visibility="hidden"});var t=this.getPageSize();$("overlay").setStyle({width:t[0]+"px",height:t[1]+"px"});new Effect.Appear(this.overlay,{duration:this.overlayDuration,from:0,to:LightboxOptions.overlayOpacity});this.imageArray=[];var n=0;if(e.rel=="lightbox"){this.imageArray.push([e.href,e.title])}else{this.imageArray=$$(e.tagName+'[href][rel="'+e.rel+'"]').collect(function(e){return[e.href,e.title]}).uniq();while(this.imageArray[n][0]!=e.href){n++}}var r=document.viewport.getScrollOffsets();var i=r[1]+document.viewport.getHeight()/10;var s=r[0];this.lightbox.setStyle({top:i+"px",left:s+"px"}).show();this.changeImage(n)},changeImage:function(e){this.activeImage=e;if(LightboxOptions.animate)this.loading.show();this.lightboxImage.hide();this.hoverNav.hide();this.prevLink.hide();this.nextLink.hide();this.imageDataContainer.setStyle({opacity:1e-4});this.numberDisplay.hide();var t=new Image;t.onload=function(){this.lightboxImage.src=this.imageArray[this.activeImage][0];this.resizeImageContainer(t.width,t.height)}.bind(this);t.src=this.imageArray[this.activeImage][0]},resizeImageContainer:function(e,t){var n=this.outerImageContainer.getWidth();var r=this.outerImageContainer.getHeight();var i=e+LightboxOptions.borderSize*2;var s=t+LightboxOptions.borderSize*2;var o=i/n*100;var u=s/r*100;var a=n-i;var f=r-s;if(f!=0)new Effect.Scale(this.outerImageContainer,u,{scaleX:false,duration:this.resizeDuration,queue:"front"});if(a!=0)new Effect.Scale(this.outerImageContainer,o,{scaleY:false,duration:this.resizeDuration,delay:this.resizeDuration});var l=0;if(f==0&&a==0){l=100;if(Prototype.Browser.IE)l=250}(function(){this.prevLink.setStyle({height:t+"px"});this.nextLink.setStyle({height:t+"px"});this.imageDataContainer.setStyle({width:i+"px"});this.showImage()}).bind(this).delay(l/1e3)},showImage:function(){this.loading.hide();new Effect.Appear(this.lightboxImage,{duration:this.resizeDuration,queue:"end",afterFinish:function(){this.updateDetails()}.bind(this)});this.preloadNeighborImages()},updateDetails:function(){if(this.imageArray[this.activeImage][1]!=""){this.caption.update(this.imageArray[this.activeImage][1]).show()}if(this.imageArray.length>1){this.numberDisplay.update(LightboxOptions.labelImage+" "+(this.activeImage+1)+" "+LightboxOptions.labelOf+"  "+this.imageArray.length).show()}new Effect.Parallel([new Effect.SlideDown(this.imageDataContainer,{sync:true,duration:this.resizeDuration,from:0,to:1}),new Effect.Appear(this.imageDataContainer,{sync:true,duration:this.resizeDuration})],{duration:this.resizeDuration,afterFinish:function(){var e=this.getPageSize();this.overlay.setStyle({height:e[1]+"px"});this.updateNav()}.bind(this)})},updateNav:function(){this.hoverNav.show();if(this.activeImage>0)this.prevLink.show();if(this.activeImage<this.imageArray.length-1)this.nextLink.show();this.enableKeyboardNav()},enableKeyboardNav:function(){document.observe("keydown",this.keyboardAction)},disableKeyboardNav:function(){document.stopObserving("keydown",this.keyboardAction)},keyboardAction:function(e){var t=e.keyCode;var n;if(e.DOM_VK_ESCAPE){n=e.DOM_VK_ESCAPE}else{n=27}var r=String.fromCharCode(t).toLowerCase();if(r.match(/x|o|c/)||t==n){this.end()}else if(r=="p"||t==37){if(this.activeImage!=0){this.disableKeyboardNav();this.changeImage(this.activeImage-1)}}else if(r=="n"||t==39){if(this.activeImage!=this.imageArray.length-1){this.disableKeyboardNav();this.changeImage(this.activeImage+1)}}},preloadNeighborImages:function(){var e,t;if(this.imageArray.length>this.activeImage+1){e=new Image;e.src=this.imageArray[this.activeImage+1][0]}if(this.activeImage>0){t=new Image;t.src=this.imageArray[this.activeImage-1][0]}},end:function(){this.disableKeyboardNav();this.lightbox.hide();new Effect.Fade(this.overlay,{duration:this.overlayDuration});$$("select","object","embed").each(function(e){e.style.visibility="visible"})},getPageSize:function(){var e,t;if(window.innerHeight&&window.scrollMaxY){e=window.innerWidth+window.scrollMaxX;t=window.innerHeight+window.scrollMaxY}else if(document.body.scrollHeight>document.body.offsetHeight){e=document.body.scrollWidth;t=document.body.scrollHeight}else{e=document.body.offsetWidth;t=document.body.offsetHeight+100}var n,r;if(self.innerHeight){if(document.documentElement.clientWidth){n=document.documentElement.clientWidth}else{n=self.innerWidth}r=self.innerHeight}else if(document.documentElement&&document.documentElement.clientHeight){n=document.documentElement.clientWidth;r=document.documentElement.clientHeight}else if(document.body){n=document.body.clientWidth;r=document.body.clientHeight}if(t<r){pageHeight=r}else{pageHeight=t}if(e<n){pageWidth=e}else{pageWidth=n}return[pageWidth,pageHeight]}};document.observe("dom:loaded",function(){if(!/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)){lightbox=new Lightbox}});